@using AnalisisPredictivoVentas.ViewModels
@model ImportResultVm

@{
    ViewData["Title"] = "Resultado de la carga";
    string Mon(decimal v) => v.ToString("C2");
}

<h2 class="mb-3">@ViewData["Title"]</h2>

@if (TempData["MailOk"] is string ok)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i> @ok
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["MailErr"] is string err)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-octagon me-1"></i> @err
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="import-result">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="card-title mb-1">
                        Archivo: <span class="fw-semibold">@Model.NombreArchivo</span>
                    </h5>
                    <div class="text-muted small">
                        @if (Model.MinFecha.HasValue || Model.MaxFecha.HasValue)
                        {
                            <span>Período: @Model.MinFecha?.ToString("yyyy-MM-dd") – @Model.MaxFecha?.ToString("yyyy-MM-dd")</span>
                            <span class="ms-3">Sucursales afectadas: @Model.SucursalesAfectadas</span>
                        }
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary" asp-controller="Uploads" asp-action="Index">
                        <i class="bi bi-arrow-left-short me-1"></i> Volver a cargas
                    </a>
                    <a class="btn btn-outline-primary" asp-controller="Home" asp-action="Index">
                        <i class="bi bi-house me-1"></i> Inicio
                    </a>
                </div>
            </div>

            <hr />

            <div class="row text-center g-3">
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Model.TotalProcesadas</div>
                    <div class="text-muted small">Ventas procesadas</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Model.VentasInsertadas</div>
                    <div class="text-success small">Ventas nuevas</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Model.VentasActualizadas</div>
                    <div class="text-primary small">Ventas actualizadas</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Model.LineasDetalle</div>
                    <div class="text-muted small">Líneas de detalle</div>
                </div>
            </div>

            <div class="row text-center g-3 mt-2">
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Model.TotalCantidad</div>
                    <div class="text-muted small">Unidades totales</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Mon(Model.TotalBruto)</div>
                    <div class="text-muted small">Total bruto</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Mon(Model.TotalDescuento)</div>
                    <div class="text-danger small">Total descuentos</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Mon(Model.TotalNeto)</div>
                    <div class="text-success small">Total ventas (neto)</div>
                </div>
            </div>

            <div class="row text-center g-3 mt-2">
                <div class="col-6 col-md-3">
                    <div class="h5 mb-0">@Mon(Model.TotalPagos)</div>
                    <div class="text-muted small">Total pagos</div>
                </div>
            </div>

            @functions {
                private static readonly Dictionary<string, string> _mapMetodos = new()
                        {
                        { "202", "EFECTIVO" },
                        { "201", "PAGO DE UNA" },
                        { "2",   "DEBITO PICHINCHA" },
                        { "7",   "DEBITO GUAYAQUIL" },
                        { "8",   "TARJETA CREDITO VISA" },
                        { "9",   "TARJETA CREDITO MASTERCARD" }
                        };

                public static string LabelMetodo(string k)
                {
                    if (string.IsNullOrWhiteSpace(k))
                        return "DESCONOCIDO";

                    k = k.Trim();

                    return _mapMetodos.TryGetValue(k, out var nombre)
                    ? nombre
                    : "TARJETA CREDITO";
                }
            }

            @if (Model.PagosPorMetodo?.Count > 0)
            {
                <div class="mt-4">
                    <h6 class="mb-2">Totales por método de pago</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr><th>Método</th><th class="text-end">Total</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var kv in Model.PagosPorMetodo.OrderBy(k => k.Key))
                                {
                                    <tr>
                                        <td>@LabelMetodo(kv.Key)</td>
                                        <td class="text-end">@Mon(kv.Value)</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th>Total</th>
                                    <th class="text-end">@Mon(Model.TotalPagos)</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            }

            @if ((Model.Errores?.Count ?? 0) > 0)
            {
                <div class="mt-4">
                    <h5 class="mb-2"><i class="bi bi-exclamation-triangle me-1"></i>Errores</h5>
                    <ul class="text-danger">
                        @foreach (var e in Model.Errores)
                        {
                            <li>@e</li>
                        }
                    </ul>
                </div>
            }
            else
            {
                <div class="alert alert-success mt-4">
                    <i class="bi bi-check-circle me-1"></i> No se registraron errores.
                </div>
            }

            <div class="mt-4 d-flex gap-2">
                <a class="btn btn-primary" asp-controller="Uploads" asp-action="Index">
                    <i class="bi bi-cloud-upload me-1"></i> Subir otro archivo
                </a>
                <a class="btn btn-outline-secondary" asp-controller="Home" asp-action="Index">
                    <i class="bi bi-house me-1"></i> Ir a Inicio
                </a>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .import-result .kpi-sub,
        .import-result small,
        .import-result .text-muted,
        .import-result .form-text {
            color: #fff !important;
            font-weight: 700;
            opacity: .95; 
        }

        .import-result .kpi-value {
            color: #fff;
            font-weight: 800;
        }

        .import-result .badge {
            color: #fff !important;
        }

        .import-result .title-sub {
            color: #fff !important;
            font-weight: 700;
        }
    </style>
}

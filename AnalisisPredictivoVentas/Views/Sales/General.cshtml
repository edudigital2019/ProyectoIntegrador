@using System.Text.Json

@{
    ViewData["Title"] = "Análisis general de Ventas";
    var year = DateTime.Now.Year;
}

@functions {
    private static readonly Dictionary<string, string> _mapMetodos = new()
    {
        { "202", "EFECTIVO" },
        { "201", "PAGO DE UNA" },
        { "2",   "DEBITO PICHINCHA" },
        { "7",   "DEBITO GUAYAQUIL" },
        { "8",   "TARJETA CREDITO VISA" },
        { "9",   "TARJETA CREDITO MASTERCARD" }
    };

    public static string LabelMetodo(string k)
    {
        if (string.IsNullOrWhiteSpace(k)) return "DESCONOCIDO";
        k = k.Trim();
        return _mapMetodos.TryGetValue(k, out var nombre) ? nombre : "TARJETA CREDITO";
    }

    public static string MetodoMapJson() => JsonSerializer.Serialize(_mapMetodos);
}

<h2>@ViewData["Title"]</h2>

<div class="row g-3 mb-3 sales-filters">
    <div class="col-lg-2">
        <label class="form-label">Año</label>
        <input id="year" type="number" class="form-control" value="@year" min="2000" max="2100" />
    </div>

    <div class="col-lg-3">
        <label class="form-label">Almacén</label>
        <div class="dropdown w-100">
            <button id="almacenDropdownBtn" class="btn btn-white border form-control text-start dropdown-toggle"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                (todos)
            </button>
            <div class="dropdown-menu p-2 w-100" style="max-height:280px; overflow:auto;">
                <div class="mb-2"><input id="almacenFilter" class="form-control form-control-sm" placeholder="Buscar almacén..." /></div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="almacenAll">
                    <label class="form-check-label" for="almacenAll">Seleccionar todos</label>
                </div>
                <div id="almacenChecks"></div>
            </div>
        </div>
        <small class="text-muted" id="almacenSummary">(todos)</small>
    </div>

    <div class="col-lg-3">
        <label class="form-label">Método de pago</label>
        <select id="metodoPago" class="form-select">
            <option value="">(todos)</option>
        </select>
    </div>

    <div class="col-lg-12 d-flex gap-2 mt-2">
        <button id="btnAplicar" class="btn btn-primary">Aplicar filtros</button>
        <button id="btnLimpiar" class="btn btn-outline-secondary">Limpiar</button>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-3"><div class="card p-3"><div class="text-white">Total neto</div><div id="kpiNeto" class="fs-4 fw-bold">—</div></div></div>
    <div class="col-md-3"><div class="card p-3"><div class="text-white">Ticket promedio</div><div id="kpiTicket" class="fs-4 fw-bold">—</div></div></div>
    <div class="col-md-3"><div class="card p-3"><div class="text-white">Unidades</div><div id="kpiUnd" class="fs-4 fw-bold">—</div></div></div>
    <div class="col-md-3"><div class="card p-3"><div class="text-white">Var. YoY</div><div id="kpiYoY" class="fs-4 fw-bold">—</div></div></div>
</div>

<div class="row g-3">
    <div class="col-lg-6"><div id="chartMetodosPago" style="min-height: 360px;"></div></div>
    <div class="col-lg-6"><div id="chartTopAlmacen" style="min-height: 360px;"></div></div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/sales.css" />
}

@section Scripts {
    <script>
        window.METODO_MAP = @Html.Raw(MetodoMapJson());
        window.labelMetodo = function (k) {
            if (!k) return 'DESCONOCIDO';
            k = ('' + k).trim();
            return (window.METODO_MAP && window.METODO_MAP[k]) ? window.METODO_MAP[k] : 'TARJETA CREDITO';
        };

        async function cargarMetodosPago() {
            const sel = document.getElementById('metodoPago');
            if (!sel) return;

            const year = document.getElementById('year')?.value ?? '';
            const categoria = document.getElementById('categoria')?.value ?? '';
            const chk = document.querySelectorAll('.chk-alm:checked');
            let almacenId = '';
            if (chk && chk.length === 1) almacenId = chk[0].value;

            const url = `/api/charts/metodos-pago?year=${encodeURIComponent(year)}&categoria=${encodeURIComponent(categoria)}&almacenId=${encodeURIComponent(almacenId)}`;

            try {
                const r = await fetch(url, { cache: 'no-store' });
                if (!r.ok) return;
                const codigos = await r.json();
                sel.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
                (codigos || []).forEach(code => {
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = window.labelMetodo(code);
                    sel.appendChild(opt);
                });
            } catch {}
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sel = document.getElementById('metodoPago');
            if (!sel) return;
            const mo = new MutationObserver(() => {
                sel.querySelectorAll('option').forEach(opt => {
                    if (opt.value && opt.value !== "" && opt.textContent === opt.value) {
                        opt.textContent = window.labelMetodo(opt.value);
                    }
                });
            });
            mo.observe(sel, { childList: true, subtree: false });
        });

        document.addEventListener('DOMContentLoaded', () => {
            cargarMetodosPago();

            const $year = document.getElementById('year');
            const $cat = document.getElementById('categoria');

            const debounce = (fn, d = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); }; };

            $year?.addEventListener('change', debounce(cargarMetodosPago, 200));
            $cat?.addEventListener('input', debounce(cargarMetodosPago, 300));

            document.addEventListener('change', (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('chk-alm')) {
                    cargarMetodosPago();
                }
            });
        });
    </script>

    <script src="~/js/sales-general.js" asp-append-version="true" defer></script>
}
